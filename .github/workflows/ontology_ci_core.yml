name: "ci(ontology): core — inline CF-ONT-101/201 (resilient+debug)"

on:
  workflow_call:

permissions:
  contents: read
  actions: write

jobs:
  validate:
    runs-on: ubuntu-latest
    timeout-minutes: 15
    steps:
      - uses: actions/checkout@v4

      - name: Debug: print env & tree (pre)
        shell: bash
        run: |
          echo "GITHUB_WORKSPACE=$GITHUB_WORKSPACE"
          echo "Runner OS: $RUNNER_OS"
          echo "Tree (top):"
          ls -la
          echo "Tree (all, depth 3):"
          find . -maxdepth 3 -type f | sed 's|^\./||' | sort

      - uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install deps
        run: |
          python -m pip install --upgrade pip
          pip install pyyaml jsonschema

      # 101..105: 실패해도 계속 진행
      - name: CF-ONT-101..105 — SignalEvent integrity (inline)
        continue-on-error: true
        shell: bash
        run: |
          python - <<'PY'
import json, sys, glob, datetime, os
os.makedirs("runs/ci", exist_ok=True)

def validate_signal(signal):
    errs=[]
    if signal.get("price_update_time") == signal.get("signal_time"): errs.append("CF-101")
    if signal.get("data_delay_ms", 0) > 3000: errs.append("CF-102")
    if signal.get("confidence_score", 1) < 0.3: errs.append("CF-103")
    if "recent_signals" in signal:
        now = datetime.datetime.now(datetime.timezone.utc)
        for prev in signal["recent_signals"]:
            try:
                t = prev.get("timestamp")
                import datetime as dt
                if isinstance(t,(int,float)):
                    ts=dt.datetime.fromtimestamp(t/1000 if t>1e12 else t, tz=dt.timezone.utc)
                elif isinstance(t,str):
                    ts=dt.datetime.fromisoformat(t.replace("Z","+00:00"))
                else:
                    continue
            except Exception:
                continue
            if prev.get("id")==signal.get("id") and (now-ts).total_seconds()<5:
                errs.append("CF-104"); break
    if signal.get("override_flag") and signal.get("confidence_score",1) < 0.1:
        errs.append("CF-105")
    return errs

candidates = sorted(set(glob.glob("runs/**/*.json",recursive=True)+
                        glob.glob("engine/**/*.json",recursive=True)+
                        glob.glob("**/signals*.json",recursive=True)))
results=[]; ok=True
for f in candidates:
    try: obj=json.load(open(f,"r",encoding="utf-8"))
    except Exception: continue
    signals=[]
    if isinstance(obj,dict):
        if obj.get("type")=="SignalEvent": signals=[obj]
        elif isinstance(obj.get("signals"),list): signals=obj["signals"]
    for s in signals:
        errs=validate_signal(s); results.append({"file":f,"errors":errs})
        if errs: ok=False
rep={"pass":ok,"details":results}
open("runs/ci/cf_ont_101.json","w",encoding="utf-8").write(json.dumps(rep,ensure_ascii=False,indent=2))
print("CF-ONT-101..105 pass=", ok)
PY

      # 201: 실패해도 계속 진행
      - name: CF-ONT-201 — SSOT registry cohesion (inline minimal)
        continue-on-error: true
        shell: bash
        run: |
          python - <<'PY'
import json, os, yaml
os.makedirs("runs/ci", exist_ok=True)
status={"pass": True, "checks":[]}
paths=["registry.yaml","registry.yml"]
exists=[p for p in paths if os.path.exists(p)]
if not exists:
    status["pass"]=False; status["checks"].append({"id":"REG-001","msg":"registry.(yaml|yml) not found"})
else:
    p=exists[0]
    try:
        data=yaml.safe_load(open(p,"r",encoding="utf-8"))
        if not isinstance(data,dict):
            status["pass"]=False; status["checks"].append({"id":"REG-002","msg":"registry root must be mapping"})
    except Exception as e:
        status["pass"]=False; status["checks"].append({"id":"REG-003","msg":f"YAML load error: {e}"})
open("runs/ci/cf_ont_201.json","w",encoding="utf-8").write(json.dumps(status,ensure_ascii=False,indent=2))
print("CF-ONT-201 pass=", status["pass"])
PY

      # 종합판정 + 리포트 생성 (여기서 최종 실패/성공 결정)
      - name: Synthesize report & decide conclusion
        shell: bash
        run: |
          python - <<'PY'
import json, os, datetime, pathlib, sys
pathlib.Path("runs/ci").mkdir(parents=True, exist_ok=True)
r={}
for f in ["runs/ci/cf_ont_101.json","runs/ci/cf_ont_201.json"]:
    if os.path.exists(f):
        try: r[os.path.basename(f)] = json.load(open(f,"r",encoding="utf-8"))
        except Exception as e: r[os.path.basename(f)] = {"read_error": True, "err": str(e)}
    else:
        r[os.path.basename(f)] = {"missing": True, "pass": False}
r["summary"]={"ts":datetime.datetime.utcnow().isoformat()+"Z",
              "pass": all(v.get("pass",False) for k,v in r.items() if k.endswith(".json"))}
open("runs/ci/validator_report.json","w",encoding="utf-8").write(json.dumps(r,ensure_ascii=False,indent=2))
print(json.dumps(r,ensure_ascii=False))
# 최종 판정은 여기서. 실패라도 다음 스텝(업로드) 진행되도록 함.
if not r["summary"]["pass"]:
    open("runs/ci/._ci_failed","w").write("fail")
PY
        continue-on-error: true

      - name: Debug: print tree (post) and ensure files exist
        shell: bash
        run: |
          echo "Post tree (runs/ci):"
          ls -la runs || true
          ls -la runs/ci || true
          test -f runs/ci/validator_report.json && echo "report exists"

      - name: Upload artifacts (fail if no files)
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: ontology-ci-artifacts
          path: runs/ci
          if-no-files-found: error
